{% extends "base.html" %}

{% block title %}Tasks - Task Manager{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Tasks</h2>
        <button class="btn btn-success" onclick="showCreateTaskModal()">+ Create Task</button>
    </div>
</div>

<!-- Filters -->
<div class="filters">
    <div class="filters-row">
        <div class="filter-group">
            <label class="form-label">Project</label>
            <select id="filter-project" class="form-control form-select" onchange="loadTasks()">
                <option value="">All Projects</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="form-label">Status</label>
            <select id="filter-status" class="form-control form-select" onchange="loadTasks()">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="form-label">Priority</label>
            <select id="filter-priority" class="form-control form-select" onchange="loadTasks()">
                <option value="">All Priorities</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>
</div>

<!-- Tasks List -->
<div id="tasks-container">
    <div class="task-list" id="tasks-list">
        <p style="text-align: center; color: var(--secondary-color); margin: 2rem 0;">Loading tasks...</p>
    </div>
</div>

<!-- Create/Edit Task Modal -->
<div class="modal" id="task-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Create New Task</h3>
            <button class="modal-close" onclick="hideTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="task-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="task-description" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Project</label>
                    <select id="task-project" class="form-control form-select">
                        <option value="">Select project...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="task-status" class="form-control form-select" required>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="task-priority" class="form-control form-select" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="datetime-local" id="task-due-date" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideTaskModal()">Cancel</button>
            <button class="btn btn-success" id="save-task-btn" onclick="saveTask()">Save Task</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Delete</h3>
            <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this task? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
            <button class="btn btn-danger" id="confirm-delete-btn" onclick="confirmDelete()">Delete Task</button>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
let projects = [];
let tasks = [];
let editingTaskId = null;
let deletingTaskId = null;

// Load initial data
async function loadTasks() {
    showLoading();
    
    try {
        // Build filter query
        const filters = new URLSearchParams();
        const projectFilter = document.getElementById('filter-project').value;
        const statusFilter = document.getElementById('filter-status').value;
        const priorityFilter = document.getElementById('filter-priority').value;
        
        if (projectFilter) filters.append('project_id', projectFilter);
        if (statusFilter) filters.append('status', statusFilter);
        if (priorityFilter) filters.append('priority', priorityFilter);
        
        const queryString = filters.toString() ? '?' + filters.toString() : '';
        
        const response = await apiGet(`/api/v1/tasks${queryString}`);
        if (response.ok) {
            const data = await response.json();
            tasks = data.tasks || [];
            displayTasks(tasks);
        } else {
            showAlert('Failed to load tasks', 'error');
        }
    } catch (error) {
        console.error('Error loading tasks:', error);
        showAlert('Error loading tasks', 'error');
    }
    
    hideLoading();
}

async function loadProjects() {
    try {
        const response = await apiGet('/api/v1/projects');
        if (response.ok) {
            const data = await response.json();
            projects = data.projects || [];
            populateProjectSelects();
        }
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

function populateProjectSelects() {
    // Populate task modal select
    const taskSelect = document.getElementById('task-project');
    taskSelect.innerHTML = '<option value="">Select project...</option>';
    
    // Populate filter select
    const filterSelect = document.getElementById('filter-project');
    filterSelect.innerHTML = '<option value="">All Projects</option>';
    
    projects.forEach(project => {
        const taskOption = document.createElement('option');
        taskOption.value = project.id;
        taskOption.textContent = project.name;
        taskSelect.appendChild(taskOption);
        
        const filterOption = document.createElement('option');
        filterOption.value = project.id;
        filterOption.textContent = project.name;
        filterSelect.appendChild(filterOption);
    });
}

function displayTasks(tasks) {
    const container = document.getElementById('tasks-list');
    
    if (tasks.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--secondary-color); margin: 2rem 0;">No tasks found</p>';
        return;
    }
    
    const tasksHTML = tasks.map(task => {
        const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date';
        const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed';
        
        return `
            <div class="task-item priority-${task.priority}" ${isOverdue ? 'style="border-left-color: #dc3545; background-color: #ffeaea;"' : ''}>
                <div class="task-header">
                    <h4 class="task-title">${task.title}</h4>
                    <span class="task-status status-${task.status}">${task.status.replace('_', ' ')}</span>
                </div>
                <div class="task-meta">
                    <span>Priority: ${task.priority}</span>
                    ${task.project_name ? `<span>Project: ${task.project_name}</span>` : ''}
                    <span>Due: ${dueDate}</span>
                    ${isOverdue ? '<span style="color: var(--danger-color); font-weight: bold;">OVERDUE</span>' : ''}
                </div>
                ${task.description ? `<p style="margin: 0.5rem 0; color: var(--secondary-color);">${task.description}</p>` : ''}
                <div class="task-actions">
                    <button class="btn btn-primary btn-sm" onclick="editTask(${task.id})">Edit</button>
                    <button class="btn btn-success btn-sm" onclick="updateTaskStatus(${task.id}, 'completed')" ${task.status === 'completed' ? 'disabled' : ''}>
                        ${task.status === 'completed' ? 'Completed' : 'Mark Complete'}
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">Delete</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = tasksHTML;
}

// Modal functions
function showCreateTaskModal() {
    editingTaskId = null;
    document.getElementById('modal-title').textContent = 'Create New Task';
    document.getElementById('save-task-btn').textContent = 'Create Task';
    document.getElementById('task-form').reset();
    document.getElementById('task-status').value = 'pending';
    document.getElementById('task-priority').value = 'medium';
    document.getElementById('task-modal').classList.add('show');
}

function hideTaskModal() {
    document.getElementById('task-modal').classList.remove('show');
    document.getElementById('task-form').reset();
    editingTaskId = null;
}

function editTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    
    editingTaskId = taskId;
    document.getElementById('modal-title').textContent = 'Edit Task';
    document.getElementById('save-task-btn').textContent = 'Update Task';
    
    document.getElementById('task-id').value = task.id;
    document.getElementById('task-title').value = task.title;
    document.getElementById('task-description').value = task.description || '';
    document.getElementById('task-project').value = task.project_id || '';
    document.getElementById('task-status').value = task.status;
    document.getElementById('task-priority').value = task.priority;
    
    if (task.due_date) {
        const date = new Date(task.due_date);
        document.getElementById('task-due-date').value = date.toISOString().slice(0, 16);
    }
    
    document.getElementById('task-modal').classList.add('show');
}

async function saveTask() {
    const taskData = {
        title: document.getElementById('task-title').value,
        description: document.getElementById('task-description').value,
        project_id: document.getElementById('task-project').value || null,
        status: document.getElementById('task-status').value,
        priority: document.getElementById('task-priority').value,
        due_date: document.getElementById('task-due-date').value || null
    };

    if (!taskData.title) {
        showAlert('Please enter a task title', 'error');
        return;
    }

    showLoading();

    try {
        let response;
        if (editingTaskId) {
            response = await apiPut(`/api/v1/tasks/${editingTaskId}`, taskData);
        } else {
            response = await apiPost('/api/v1/tasks', taskData);
        }

        const result = await response.json();

        if (response.ok) {
            showAlert(`Task ${editingTaskId ? 'updated' : 'created'} successfully!`, 'success');
            hideTaskModal();
            loadTasks();
        } else {
            showAlert(result.error || `Failed to ${editingTaskId ? 'update' : 'create'} task`, 'error');
        }
    } catch (error) {
        console.error('Error saving task:', error);
        showAlert('Error saving task', 'error');
    }

    hideLoading();
}

async function updateTaskStatus(taskId, status) {
    showLoading();
    
    try {
        const response = await apiPut(`/api/v1/tasks/${taskId}`, { status });
        
        if (response.ok) {
            showAlert('Task status updated!', 'success');
            loadTasks();
        } else {
            const result = await response.json();
            showAlert(result.error || 'Failed to update task status', 'error');
        }
    } catch (error) {
        console.error('Error updating task status:', error);
        showAlert('Error updating task status', 'error');
    }
    
    hideLoading();
}

function deleteTask(taskId) {
    deletingTaskId = taskId;
    document.getElementById('delete-modal').classList.add('show');
}

function hideDeleteModal() {
    document.getElementById('delete-modal').classList.remove('show');
    deletingTaskId = null;
}

async function confirmDelete() {
    if (!deletingTaskId) return;
    
    showLoading();
    
    try {
        const response = await apiDelete(`/api/v1/tasks/${deletingTaskId}`);
        
        if (response.ok) {
            showAlert('Task deleted successfully!', 'success');
            hideDeleteModal();
            loadTasks();
        } else {
            const result = await response.json();
            showAlert(result.error || 'Failed to delete task', 'error');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showAlert('Error deleting task', 'error');
    }
    
    hideLoading();
}

function clearFilters() {
    document.getElementById('filter-project').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-priority').value = '';
    loadTasks();
}

// Refresh function for WebSocket updates
window.refreshTasks = loadTasks;

// Load initial data
loadProjects();
loadTasks();
{% endblock %}