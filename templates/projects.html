{% extends "base.html" %}

{% block title %}Projects - Task Manager{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Projects</h2>
        <button class="btn btn-success" onclick="showCreateProjectModal()">+ Create Project</button>
    </div>
</div>

<!-- Projects Grid -->
<div id="projects-container">
    <div class="project-grid" id="projects-grid">
        <p style="text-align: center; color: var(--secondary-color); margin: 2rem 0;">Loading projects...</p>
    </div>
</div>

<!-- Create/Edit Project Modal -->
<div class="modal" id="project-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="project-modal-title">Create New Project</h3>
            <button class="modal-close" onclick="hideProjectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="project-form">
                <input type="hidden" id="project-id">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" id="project-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="project-description" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <input type="color" id="project-color" class="form-control" value="#007bff">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideProjectModal()">Cancel</button>
            <button class="btn btn-success" id="save-project-btn" onclick="saveProject()">Save Project</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Delete</h3>
            <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this project? This will also delete all associated tasks.</p>
            <p><strong>This action cannot be undone.</strong></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
            <button class="btn btn-danger" id="confirm-delete-btn" onclick="confirmDelete()">Delete Project</button>
        </div>
    </div>
</div>

<!-- Project Members Modal -->
<div class="modal" id="members-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Project Members</h3>
            <button class="modal-close" onclick="hideMembersModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Add Member by Email</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="email" id="member-email" class="form-control" placeholder="Enter user email">
                    <button class="btn btn-primary" onclick="addMember()">Add</button>
                </div>
            </div>
            <div id="members-list">
                <p style="text-align: center; color: var(--secondary-color);">Loading members...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideMembersModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
let projects = [];
let editingProjectId = null;
let deletingProjectId = null;
let currentProjectMembers = [];
let currentProjectId = null;

// Load projects
async function loadProjects() {
    showLoading();
    
    try {
        const response = await apiGet('/api/v1/projects');
        if (response.ok) {
            const data = await response.json();
            projects = data.projects || [];
            displayProjects(projects);
        } else {
            showAlert('Failed to load projects', 'error');
        }
    } catch (error) {
        console.error('Error loading projects:', error);
        showAlert('Error loading projects', 'error');
    }
    
    hideLoading();
}

function displayProjects(projects) {
    const container = document.getElementById('projects-grid');
    
    if (projects.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--secondary-color); margin: 2rem 0; grid-column: 1 / -1;">No projects found</p>';
        return;
    }
    
    const projectsHTML = projects.map(project => {
        const createdDate = new Date(project.created_at).toLocaleDateString();
        const updatedDate = new Date(project.updated_at).toLocaleDateString();
        
        return `
            <div class="project-card">
                <div class="project-header" style="background: linear-gradient(135deg, ${project.color || '#007bff'}, ${adjustColorBrightness(project.color || '#007bff', -20)});">
                    <h3 class="project-title">${project.name}</h3>
                    <p class="project-description">${project.description || 'No description'}</p>
                </div>
                <div class="project-body">
                    <div class="project-stats">
                        <div class="stat">
                            <div class="stat-number">${project.task_count || 0}</div>
                            <div class="stat-label">Tasks</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${project.completed_tasks || 0}</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${project.member_count || 1}</div>
                            <div class="stat-label">Members</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--secondary-color);">
                        <div>Created: ${createdDate}</div>
                        <div>Updated: ${updatedDate}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-sm" onclick="editProject(${project.id})">Edit</button>
                        <button class="btn btn-secondary btn-sm" onclick="manageMembers(${project.id})">Members</button>
                        <a href="/tasks?project_id=${project.id}" class="btn btn-info btn-sm" style="color: white; text-decoration: none;">View Tasks</a>
                        <button class="btn btn-danger btn-sm" onclick="deleteProject(${project.id})">Delete</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = projectsHTML;
}

// Utility function to adjust color brightness
function adjustColorBrightness(color, amount) {
    const usePound = color[0] === "#";
    const col = usePound ? color.slice(1) : color;
    const num = parseInt(col, 16);
    let r = (num >> 16) + amount;
    let g = (num >> 8 & 0x00FF) + amount;
    let b = (num & 0x0000FF) + amount;
    r = r > 255 ? 255 : r < 0 ? 0 : r;
    g = g > 255 ? 255 : g < 0 ? 0 : g;
    b = b > 255 ? 255 : b < 0 ? 0 : b;
    return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);
}

// Modal functions
function showCreateProjectModal() {
    editingProjectId = null;
    document.getElementById('project-modal-title').textContent = 'Create New Project';
    document.getElementById('save-project-btn').textContent = 'Create Project';
    document.getElementById('project-form').reset();
    document.getElementById('project-color').value = '#007bff';
    document.getElementById('project-modal').classList.add('show');
}

function hideProjectModal() {
    document.getElementById('project-modal').classList.remove('show');
    document.getElementById('project-form').reset();
    editingProjectId = null;
}

function editProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    editingProjectId = projectId;
    document.getElementById('project-modal-title').textContent = 'Edit Project';
    document.getElementById('save-project-btn').textContent = 'Update Project';
    
    document.getElementById('project-id').value = project.id;
    document.getElementById('project-name').value = project.name;
    document.getElementById('project-description').value = project.description || '';
    document.getElementById('project-color').value = project.color || '#007bff';
    
    document.getElementById('project-modal').classList.add('show');
}

async function saveProject() {
    const projectData = {
        name: document.getElementById('project-name').value,
        description: document.getElementById('project-description').value,
        color: document.getElementById('project-color').value
    };

    if (!projectData.name) {
        showAlert('Please enter a project name', 'error');
        return;
    }

    showLoading();

    try {
        let response;
        if (editingProjectId) {
            response = await apiPut(`/api/v1/projects/${editingProjectId}`, projectData);
        } else {
            response = await apiPost('/api/v1/projects', projectData);
        }

        const result = await response.json();

        if (response.ok) {
            showAlert(`Project ${editingProjectId ? 'updated' : 'created'} successfully!`, 'success');
            hideProjectModal();
            loadProjects();
        } else {
            showAlert(result.error || `Failed to ${editingProjectId ? 'update' : 'create'} project`, 'error');
        }
    } catch (error) {
        console.error('Error saving project:', error);
        showAlert('Error saving project', 'error');
    }

    hideLoading();
}

function deleteProject(projectId) {
    deletingProjectId = projectId;
    document.getElementById('delete-modal').classList.add('show');
}

function hideDeleteModal() {
    document.getElementById('delete-modal').classList.remove('show');
    deletingProjectId = null;
}

async function confirmDelete() {
    if (!deletingProjectId) return;
    
    showLoading();
    
    try {
        const response = await apiDelete(`/api/v1/projects/${deletingProjectId}`);
        
        if (response.ok) {
            showAlert('Project deleted successfully!', 'success');
            hideDeleteModal();
            loadProjects();
        } else {
            const result = await response.json();
            showAlert(result.error || 'Failed to delete project', 'error');
        }
    } catch (error) {
        console.error('Error deleting project:', error);
        showAlert('Error deleting project', 'error');
    }
    
    hideLoading();
}

// Members management
async function manageMembers(projectId) {
    currentProjectId = projectId;
    document.getElementById('members-modal').classList.add('show');
    loadProjectMembers(projectId);
}

function hideMembersModal() {
    document.getElementById('members-modal').classList.remove('show');
    currentProjectId = null;
    currentProjectMembers = [];
}

async function loadProjectMembers(projectId) {
    try {
        const response = await apiGet(`/api/v1/projects/${projectId}/members`);
        if (response.ok) {
            const data = await response.json();
            currentProjectMembers = data.members || [];
            displayProjectMembers();
        } else {
            showAlert('Failed to load project members', 'error');
        }
    } catch (error) {
        console.error('Error loading project members:', error);
        showAlert('Error loading project members', 'error');
    }
}

function displayProjectMembers() {
    const container = document.getElementById('members-list');
    
    if (currentProjectMembers.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--secondary-color);">No additional members</p>';
        return;
    }
    
    const membersHTML = currentProjectMembers.map(member => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border: 1px solid #eee; border-radius: var(--border-radius); margin-bottom: 0.5rem;">
            <div>
                <strong>${member.full_name || member.username}</strong>
                <div style="font-size: 0.875rem; color: var(--secondary-color);">${member.email}</div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="removeMember(${member.id})">Remove</button>
        </div>
    `).join('');
    
    container.innerHTML = membersHTML;
}

async function addMember() {
    const email = document.getElementById('member-email').value.trim();
    if (!email) {
        showAlert('Please enter an email address', 'error');
        return;
    }

    showLoading();

    try {
        const response = await apiPost(`/api/v1/projects/${currentProjectId}/members`, {
            email: email
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Member added successfully!', 'success');
            document.getElementById('member-email').value = '';
            loadProjectMembers(currentProjectId);
            loadProjects(); // Refresh project stats
        } else {
            showAlert(result.error || 'Failed to add member', 'error');
        }
    } catch (error) {
        console.error('Error adding member:', error);
        showAlert('Error adding member', 'error');
    }

    hideLoading();
}

async function removeMember(userId) {
    showLoading();

    try {
        const response = await apiDelete(`/api/v1/projects/${currentProjectId}/members/${userId}`);

        if (response.ok) {
            showAlert('Member removed successfully!', 'success');
            loadProjectMembers(currentProjectId);
            loadProjects(); // Refresh project stats
        } else {
            const result = await response.json();
            showAlert(result.error || 'Failed to remove member', 'error');
        }
    } catch (error) {
        console.error('Error removing member:', error);
        showAlert('Error removing member', 'error');
    }

    hideLoading();
}

// Refresh function for WebSocket updates
window.refreshProjects = loadProjects;

// Load initial data
loadProjects();
{% endblock %}